---
thumbnail:
cover:
title: '[学习笔记]批量迁移数据库文件'
excerpt:
description:
date: 2023-12-20 17:12:00
tags:
categories: 
toc: true
recommend: 1
keywords: categories-java
uniqueId: 2023-12-20 17:12:00/[学习笔记]批量迁移数据库文件.html
---


## 拷贝数据库文件

首先在本地运行如下SQL语句，查看数据库文件的磁盘位置
```
SELECT name, physical_name AS CurrentLocation, state_desc
FROM sys.master_files
```

默认是保存在`C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA`目录下

![在这里插入图片描述](644861-20231220171129160-221846004.png)

首先复制数据库文件到新的磁盘位置，比如`E:\DATA\`

## 更新索引

SQL server可以使用下面语句更改用户数据库的文件位置索引
```
ALTER DATABASE database_name MODIFY FILE ( NAME = logical_name, FILENAME = 'new_path\os_file_name' );
```

更多移动用户数据库内容请查看官方文档  https://learn.microsoft.com/zh-cn/sql/relational-databases/databases/move-user-databases


运行如下SQL语句

```
DECLARE @database_name NVARCHAR(128), @logical_name NVARCHAR(128), @sql NVARCHAR(MAX), @new_path NVARCHAR(256);

SET @new_path = N'E:\DATA\'; -- new file path

DECLARE db_cursor CURSOR FOR 
SELECT DB_NAME(database_id), name 
FROM sys.master_files
WHERE type = 0;

OPEN db_cursor;  
FETCH NEXT FROM db_cursor INTO @database_name, @logical_name;  

WHILE @@FETCH_STATUS = 0  
BEGIN  
    SET @sql = N'ALTER DATABASE ' + QUOTENAME(@database_name) + 
               N' MODIFY FILE ( NAME = ' + QUOTENAME(@logical_name, '''') + 
               N' , FILENAME = ' + QUOTENAME(@new_path + @logical_name + '.mdf', '''') + N' )';
    EXEC sp_executesql @sql;

    FETCH NEXT FROM db_cursor INTO @database_name, @logical_name;  
END; 

CLOSE db_cursor;  
DEALLOCATE db_cursor;

```

分别迁移数据库文件和日志文件
![在这里插入图片描述](644861-20231220171129166-747734690.png)


运行后会提示下次启动数据库时生效

![在这里插入图片描述](644861-20231220171129176-1514751479.png)






再次查看sys.master_files内容，可以看到数据库文件已经迁移到新的磁盘位置

![在这里插入图片描述](644861-20231220171129106-492802479.png)
## 重启服务

打开SQL Server 配置管理器，如果你更改了系统数据库的位置，需要在SQL server服务的属性中，更改启动参数，详情请参考官方文档：https://learn.microsoft.com/zh-cn/sql/relational-databases/databases/move-system-databases

![在这里插入图片描述](644861-20231220171129202-1209282596.png)

![在这里插入图片描述](644861-20231220171129161-294669963.png)
重启服务

![在这里插入图片描述](644861-20231220171129398-800973374.png)


删除之前的数据库文件，完成迁移