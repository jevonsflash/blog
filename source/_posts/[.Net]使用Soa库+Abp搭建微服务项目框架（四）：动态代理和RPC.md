---
thumbnail: >-
  images/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16
title: '[.Net]使用Soa库+Abp搭建微服务项目框架（四）：动态代理和RPC'
excerpt: "上一章我们完成了小项目的面向服务体系改造，你或许一直在思考一个问题。为什么要将业务独立成微服务？以一个健康医疗系统为例， 这个系统包含了用户模块，问卷的发放与填写，图表显示，报表生成与查看，患者管理等功能，传统的架构如下：随着项目规模的增长，在开发过程中会发现如下问题：各模块之间耦合严重，比如：报表模块引用了问卷，用户，随访，患者管理等几乎所有模块，难以维护\t间接引用的情况过多，导致项目分层不明确，容易产生引用分歧，难以维护目前做的就是解耦各个模块之间的强关联状态，通过第一章提到的上下文"
tags:
  - .net
  - EFCore
  - 微服务
categories:
  - .NET
toc: true
recommend: 1
keywords: categories-java
uniqueId: '2022-01-15 10:14:00/[.Net]使用Soa库+Abp搭建微服务项目框架（四）：动态代理和RPC.html'
abbrlink: 8090d4cd
date: 2022-01-15 10:14:00
cover:
description:
---
<p><span data-cke-copybin-start="1"><span data-cke-copybin-start="1">​</span></span><span id="cke_bm_220S">上一章我们完成了小项目的面向服务体系改造，你或许一直在思考一个问题。<strong>为什么要将业务独立成微服务？</strong></span></p>
<h3>微服务原理</h3>
<p>以一个健康医疗系统为例， 这个系统包含了用户模块，问卷的发放与填写，图表显示，报表生成与查看，患者管理等功能，传统的架构如下：</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="13" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/5c6494304e134d0daf027c339ba896eb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="288" height="295" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/5c6494304e134d0daf027c339ba896eb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F5c6494304e134d0daf027c339ba896eb.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22288%22%2C%22height%22%3A%22295%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>随着项目规模的增长，在开发过程中会发现如下问题：</p>
<ol>
<li>各模块之间耦合严重，比如：报表模块引用了问卷，用户，随访，患者管理等几乎所有模块，难以维护</li>
<li>间接引用的情况过多，导致项目分层不明确，容易产生引用分歧，难以维护</li>
</ol>
<p>目前做的就是解耦各个模块之间的强关联状态，通过第一章提到的上下文边界划分方式，我们大致可以将系统的架构改造如下：</p>
<p>&nbsp;</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="12" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/b632c6a0d90c4894b874f716aeb024a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="507" height="369" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/b632c6a0d90c4894b874f716aeb024a9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fb632c6a0d90c4894b874f716aeb024a9.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22507%22%2C%22height%22%3A%22369%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>通过调用者和实现者共同引用抽象的方式，解耦程序集之间的引用</p>
<p>各微服务之间用RPC方式通信，实现各服务之间独立运行，独立部署，互不干涉&nbsp;</p>
<p>我们了解一下微服务的概念：</p>
<ol>
<li>将单一应用程序划分成多个小的服务，每个服务围绕单一业务进行构建</li>
<li>每个服务可<strong>独立部署，独立运行，独立测试</strong></li>
<li>服务之间采用<strong>轻量级的通信机制</strong>互相沟通&nbsp;。</li>
</ol>
<p>在回到我们的代码上来。讨论一下改造之后的项目特性：</p>
<p>第一</p>
<ul>
<li>整体业务用上下文边界划分方式，围绕单一业务模型构建的领域模型，领域层互不干涉</li>
<li>Host服务仅依赖自身的领域层，而领域层也是单一职责构建的，Host服务互不干涉</li>
<li>每个Host服务可以配置独立的数据库连接字符串，数据互不干涉</li>
</ul>
<p>第二</p>
<ul>
<li>各Host项目可以配置端口和ip，可独立部署至不同的网络环境。</li>
<li>各Host都独立生成exe文件，可以独立运行。</li>
</ul>
<p>我们来模拟一下其中一个服务崩溃的场景：假设将Service1.Host和Service2.Host 关掉，再次请求GetExtends<span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="11" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/0a01fa651fed46a1b8c373a5ad79b782.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="874" height="375" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/0a01fa651fed46a1b8c373a5ad79b782.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F0a01fa651fed46a1b8c373a5ad79b782.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22874%22%2C%22height%22%3A%22375%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>&nbsp;可以发现主服务是可用的，只是type和num拿不到值而已，这证明了调用者不依赖于其他服务而保持独立运行。</p>
<ul>
<li>若是Http方式参与远程过程调用，可以用浏览器，或者PostMan调试各项目</li>
</ul>
<p>&nbsp;</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="10" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/6006ce37e837409c8d3c478f375f69fd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="518" height="543" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/6006ce37e837409c8d3c478f375f69fd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F6006ce37e837409c8d3c478f375f69fd.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22518%22%2C%22height%22%3A%22543%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>（使用PostMan调试微服务）</p>
<h3>动态代理与RPC</h3>
<ul>
<li>RPC（Remote Procedure Call）远程过程调用，简单的理解是一个节点请求另一个节点提供的服务，整个项目是使用Http协议实现RPC通信。</li>
</ul>
<p>下面来介绍一下Soa库如何实现RPC通信的：</p>
<p>首先Soa库将所有继承ISoaService的类，用SyntaxFactory生成代理类对象，并生代理类程序集（名称为目标程序集+Proxy），它的字节流加载进内存中，这些代理类中的成员对象与目标类型一模一样。同样继承了IServiceManager。</p>
<p>但是实现方式改为调用SoaClient，通过反编译工具可以看到，代理类的结构</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="9" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/4e5ecfa4e8064f438b9eecd8fbbfe9d0.png" alt="" width="248" height="106" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/4e5ecfa4e8064f438b9eecd8fbbfe9d0.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F4e5ecfa4e8064f438b9eecd8fbbfe9d0.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22248%22%2C%22height%22%3A%22106%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>&nbsp;<span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="8" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/80a40ac6a7c5426c815c8230e00f354a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="785" height="264" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/80a40ac6a7c5426c815c8230e00f354a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F80a40ac6a7c5426c815c8230e00f354a.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22785%22%2C%22height%22%3A%22264%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>&nbsp;</p>
<p>当客户端调用代理类中的方法，它将生成目标方法的Id（一般是类名＋方法名）、参数内容、目标方法的描述（签名类型，返回值等内容），之后根据此映射的ip地址和端口号，打包发送至服务端。</p>
<p>服务端接受到报文之后，通过ServiceId找到目标方法的描述，用反射的方式Invoke目标方法，并将返回内容序列化后打包至响应报文</p>
<p>接口描述配置</p>
<p>在SoaService属性中设置创建时间，创建人员，备注等，以供服务治理提供信息</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="7" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/7f51b4d3023a454c8c4aa3a3217e7492.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="613" height="53" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/7f51b4d3023a454c8c4aa3a3217e7492.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F7f51b4d3023a454c8c4aa3a3217e7492.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22613%22%2C%22height%22%3A%2253%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>在微服务Service1.Host项目中的appsettings.json中，配置如下：&nbsp;</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="6" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%7B%5Cn%20%20%5C%22SoaServer%5C%22%3A%20%7B%5Cn%20%20%20%20%5C%22Name%5C%22%3A%20%5C%22Service1%5C%22%2C%5Cn%20%20%20%20%5C%22Ip%5C%22%3A%20%5C%22127.0.0.1%5C%22%2C%5Cn%20%20%20%20%5C%22Port%5C%22%3A%20%5C%228007%5C%22%2C%5Cn%20%20%20%20%5C%22Transport%5C%22%3A%20%5C%22Http%5C%22%2C%5Cn%20%20%20%20%5C%22AssemblyNames%5C%22%3A%20%5C%22Soa.Sample.IService1%2CSoa.Sample.Service1%5C%22%5Cn%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">{
  <span class="hljs-string">"SoaServer": {
    <span class="hljs-string">"Name": <span class="hljs-string">"Service1",
    <span class="hljs-string">"Ip": <span class="hljs-string">"127.0.0.1",
    <span class="hljs-string">"Port": <span class="hljs-string">"8007",
    <span class="hljs-string">"Transport": <span class="hljs-string">"Http",
    <span class="hljs-string">"AssemblyNames": <span class="hljs-string">"Soa.Sample.IService1,Soa.Sample.Service1"
}</span></span></span></span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>在微服务Service2.Host项目中的appsettings.json中，配置如下：&nbsp;</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="5" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%7B%5Cn%20%20%5C%22SoaServer%5C%22%3A%20%7B%5Cn%20%20%20%20%5C%22Name%5C%22%3A%20%5C%22Service2%5C%22%2C%5Cn%20%20%20%20%5C%22Ip%5C%22%3A%20%5C%22127.0.0.1%5C%22%2C%5Cn%20%20%20%20%5C%22Port%5C%22%3A%20%5C%228008%5C%22%2C%5Cn%20%20%20%20%5C%22Transport%5C%22%3A%20%5C%22Http%5C%22%2C%5Cn%20%20%20%20%5C%22AssemblyNames%5C%22%3A%20%5C%22Soa.Sample.IService2%2CSoa.Sample.Service2%5C%22%5Cn%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">{
  <span class="hljs-string">"SoaServer": {
    <span class="hljs-string">"Name": <span class="hljs-string">"Service2",
    <span class="hljs-string">"Ip": <span class="hljs-string">"127.0.0.1",
    <span class="hljs-string">"Port": <span class="hljs-string">"8008",
    <span class="hljs-string">"Transport": <span class="hljs-string">"Http",
    <span class="hljs-string">"AssemblyNames": <span class="hljs-string">"Soa.Sample.IService2,Soa.Sample.Service2"
}</span></span></span></span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>Service1与Service2的抽象层分别添加SoaServiceRoute标签，方法添加SoaService标签：</p>
<p>IService1Manager.cs</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="4" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22cs%22%2C%22code%22%3A%22namespace%20Soa.Sample.IService1%5Cn%7B%5Cn%20%20%20%20%5BSoaServiceRoute(%5C%22soa_api%2Fservice1%5C%22)%5D%5Cn%20%20%20%20public%20interface%20IService1Manager%20%3A%20ISoaService%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%5BSoaService(CreatedBy%20%3D%20%5C%22linxiao%5C%22%2C%20Comment%20%3D%20%5C%22get%20type%20by%20main%20id%5C%22)%5D%5Cn%20%20%20%20%20%20%20%20public%20string%20GetType(long%20mainId)%3B%5Cn%5Cn%20%20%20%20%7D%5Cn%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-cs hljs"><span class="hljs-keyword">namespace <span class="hljs-title">Soa.Sample.IService1
{
    [<span class="hljs-meta">SoaServiceRoute(<span class="hljs-string">"soa_api/service1")]
    <span class="hljs-keyword">public <span class="hljs-keyword">interface <span class="hljs-title">IService1Manager : <span class="hljs-title">ISoaService
    {
        [<span class="hljs-meta">SoaService(CreatedBy = <span class="hljs-string">"linxiao", Comment = <span class="hljs-string">"get type by main id")]
        <span class="hljs-function"><span class="hljs-keyword">public <span class="hljs-built_in">string <span class="hljs-title">GetType(<span class="hljs-params"><span class="hljs-built_in">long mainId);

    }
}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>IService2Manager.cs&nbsp;</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="3" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22cs%22%2C%22code%22%3A%22namespace%20Soa.Sample.IService2%5Cn%7B%5Cn%20%20%20%20%5BSoaServiceRoute(%5C%22soa_api%2Fservice2%5C%22)%5D%5Cn%20%20%20%20public%20interface%20IService2Manager%20%3A%20ISoaService%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%5BSoaService(CreatedBy%20%3D%20%5C%22linxiao%5C%22%2C%20Comment%20%3D%20%5C%22get%20num%20by%20main%20id%5C%22%2C%20EnableAuthorization%20%3D%20true)%5D%5Cn%20%20%20%20%20%20%20%20public%20int%20GetNum(long%20mainId)%3B%5Cn%5Cn%20%20%20%20%7D%5Cn%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-cs hljs"><span class="hljs-keyword">namespace <span class="hljs-title">Soa.Sample.IService2
{
    [<span class="hljs-meta">SoaServiceRoute(<span class="hljs-string">"soa_api/service2")]
    <span class="hljs-keyword">public <span class="hljs-keyword">interface <span class="hljs-title">IService2Manager : <span class="hljs-title">ISoaService
    {
        [<span class="hljs-meta">SoaService(CreatedBy = <span class="hljs-string">"linxiao", Comment = <span class="hljs-string">"get num by main id", EnableAuthorization = true)]
        <span class="hljs-function"><span class="hljs-keyword">public <span class="hljs-built_in">int <span class="hljs-title">GetNum(<span class="hljs-params"><span class="hljs-built_in">long mainId);

    }
}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>设置完成后：</p>
<p>客户端访问127.0.0.1:8007/soa_api/service1/GetType 将调用Service1的GetType方法。</p>
<p>客户端访问127.0.0.1:8008/soa_api/service2/GetNum 将调用Service2的GetNum方法。</p>
<p>再次调用GetExtends方法，我们已经拿到想要的值</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="2" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/b45c6d76ddff46e7b3cd09434718adaa.png" alt="" width="572" height="383" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/b45c6d76ddff46e7b3cd09434718adaa.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fb45c6d76ddff46e7b3cd09434718adaa.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22572%22%2C%22height%22%3A%22383%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>&nbsp;</p>
<h3>结语</h3>
<p>需要注意的是，此时的架构优化并不是传统意义上的微服务，而是一种面向服务体系的架构</p>
<p>传统意义上的微服务，应该基于去中心化的思想而构建，类似下图：</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="1" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/02f32ec59d9342feb3b2d72fd8313500.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="1195" height="637" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/02f32ec59d9342feb3b2d72fd8313500.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F02f32ec59d9342feb3b2d72fd8313500.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221195%22%2C%22height%22%3A%22637%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171326999-1179920079.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>它包含一个网关，由它来路由请求到各个服务。由它进行鉴权认证，和健康监测。</p>
<p>意味着这个小项目和Soa库还有一段路要走。有时间还会继续更新这个系列文章，欢迎留言或评论。</p>
<h3>项目地址</h3>
<p><br />
<span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="0" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" title="MatoApps/Soa (github.com)" href="https://github.com/MatoApps/Soa" data-cke-enter-mode="2" data-cke-saved-href="https://github.com/MatoApps/Soa" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fgithub.com%2FMatoApps%2FSoa%22%2C%22text%22%3A%22MatoApps%2FSoa%20(github.com)%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22id%22%3A%22l7BnKy-1652173894803%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.0/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M3K6" data-link-title="MatoApps/Soa (github.com)" data-widget="csdnlink">MatoApps/Soa (github.com)</a></span></p>
<p>
<span data-cke-copybin-start="1">
<span data-cke-copybin-end="1">​</span></span></p>