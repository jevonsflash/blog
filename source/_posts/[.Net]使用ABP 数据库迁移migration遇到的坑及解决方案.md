---
thumbnail: 'images/20210624114640937.png'
cover:
title: '[.Net]使用ABP 数据库迁移migration遇到的坑及解决方案'
excerpt: '问题：在使用Update-Database时，突然出现“数据库中已存在名为 'XXX' 的对象”。检查发现__EFMigrationsHistory表中的MigrationId与项目中的EntityFrameworkCore项目中的Migrations内容有不同的地方。ABP的更新机制是对比数据库的id与Migrations各文件Id，如果数据库缺少则往下继续执行，但如果有id冲突，则会认为产生分支，从第一个开始执行了。结果造成读到的全部是CREATE TABLE 的操作，从而产生冲突。解决'
description:
date: 2022-01-15 09:58:00
tags:
  - .net

categories:
  - .NET
 
toc: true
recommend: 1
keywords: categories-java
uniqueId: 2022-01-15 09:58:00/[.Net]使用ABP 数据库迁移migration遇到的坑及解决方案.html
---
<p><span data-cke-copybin-start="1"><span data-cke-copybin-start="1">​</span></span></p>
<p><span id="cke_bm_313S">&nbsp;问题：在使用Update-Database时，突然出现&ldquo;数据库中已存在名为 'XXX' 的对象&rdquo;。</span></p>
<p>检查发现__EFMigrationsHistory表中的MigrationId与项目中的EntityFrameworkCore项目中的Migrations内容有不同的地方。</p>
<p>ABP的更新机制是对比数据库的id与Migrations各文件Id，如果数据库缺少则往下继续执行，但如果有id冲突，则会认为产生分支，从第一个开始执行了。结果造成读到的全部是CREATE TABLE 的操作，从而产生冲突。</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="3" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/20210624114850700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" alt="" width="354" height="212" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/20210624114850700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210624114850700.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22354%22%2C%22height%22%3A%22212%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2020.cnblogs.com/blog/644861/202201/644861-20220115095819435-324783181.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​<span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="2" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/20210624113921258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" alt="" width="305" height="256" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/20210624113921258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210624113921258.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22305%22%2C%22height%22%3A%22256%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2020.cnblogs.com/blog/644861/202201/644861-20220115095819435-324783181.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></span></span></span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="3" data-cke-widget-wrapper="1"><span class="cke_reset cke_widget_drag_handler_container"><span class="cke_image_resizer" title="点击并拖拽以改变尺寸"><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="2" data-cke-widget-wrapper="1"><span class="cke_reset cke_widget_drag_handler_container"><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></span></span></span></p>
<p>解决办法：修改MigrationID与源文件文件名一致，如下图，我已将20210618072019_init_0618.cs改成了20210618070222_init_0618.cs 虽然迁移名称都是init_0618，但是ABP还是会根据Id判断一致性的。</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="1" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/2021062411400185.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" alt="" width="337" height="211" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/2021062411400185.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo,size_16,color_FFFFFF,t_70" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F2021062411400185.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pldm9uc2ZsYXNo%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22337%22%2C%22height%22%3A%22211%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2020.cnblogs.com/blog/644861/202201/644861-20220115095819435-324783181.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>当然光改文件名还不行，要去Design文件下更改Migration标签</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="0" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/20210624114640937.png" alt="" width="350" height="111" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/20210624114640937.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F20210624114640937.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22350%22%2C%22height%22%3A%22111%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2020.cnblogs.com/blog/644861/202201/644861-20220115095819435-324783181.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p><span data-cke-copybin-start="1"><span data-cke-copybin-end="1">​</span></span></p>