---
thumbnail:
cover:
title: '[.Net]使用Soa库+Abp搭建微服务项目框架（五）：服务发现和健康监测'
excerpt:
description:
date: 2022-05-10 17:18:00
tags:
  - .net
  - asp.net core
  - 微服务

categories:
  - .NET
 
toc: true
recommend: 1
keywords: categories-java
uniqueId: 2022-05-10 17:18:00/[.Net]使用Soa库+Abp搭建微服务项目框架（五）：服务发现和健康监测.html
---
<span data-cke-copybin-start="1"><span data-cke-copybin-start="1">​</span></span><span id="cke_bm_638S">上篇文章说过，服务发现和健康监测是面向服务体系架构重要的模块，Soa库可以配置使用Consul作为服务发现服务，或者轮询已配置的服务列表作为本机服务发现。</span>
<p>将用Hangfire来作为服务发现与健康监测的定时执行库</p>
<p>具体配置信息请参考<span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="16" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" title="Hangfire &ndash; Background jobs and workers for .NET and .NET Core" href="https://www.hangfire.io/" data-cke-enter-mode="2" data-cke-saved-href="https://www.hangfire.io/" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fwww.hangfire.io%2F%22%2C%22text%22%3A%22Hangfire%20%E2%80%93%20Background%20jobs%20and%20workers%20for%20.NET%20and%20.NET%20Core%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22id%22%3A%22IFvCep-1652174174477%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.0/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M3K6" data-link-title="Hangfire &ndash; Background jobs and workers for .NET and .NET Core" data-widget="csdnlink">Hangfire &ndash; Background jobs and workers for .NET and .NET Core</a></span></p>
<h2>服务发现</h2>
<p>配置各个服务的地址列表，或者在服务启动时注册的key-value地址集合，轮询地址服务描述服务（GetRoutesDescAsync），确定服务中方法的路由，方法签名，使用方式，描述（功能，作者）等内容。</p>
<h3>本机服务发现（InServer）</h3>
<p>本机服务发现将轮询Address配置中的地址所对应的RoutesGetters，执行获取路由信息，并更新SoaServiceRoute中的Address集合</p>
<p>每个微服务都有一个Id 为&nbsp;"Soa.ServiceDiscovery.InServer.GetRoutesDescAsync"的方法</p>
<p>获取该服务的地址，服务描述。</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="15" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/a736acb2f9cb40cbb1b96834093f80f1.png" alt="" width="785" height="32" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/a736acb2f9cb40cbb1b96834093f80f1.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fa736acb2f9cb40cbb1b96834093f80f1.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22785%22%2C%22height%22%3A%2232%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>在服务模块初始化中已经将这个服务路由对象添加到RoutesGetters</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="14" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22cs%22%2C%22code%22%3A%22var%20service%20%3D%20new%20SoaServiceRoute%5Cn%7B%5Cn%20%20%20%20Address%20%3D%20new%20List%3CSoaAddress%3E%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20addr%5Cn%20%20%20%20%7D%2C%5Cn%20%20%20%20ServiceDescriptor%20%3D%20new%20SoaServiceDesc%20%7B%20Id%20%3D%20%5C%22Soa.ServiceDiscovery.InServer.GetRoutesDescAsync%5C%22%20%7D%5Cn%7D%3B%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-cs hljs"><span class="hljs-keyword">var service = <span class="hljs-keyword">new SoaServiceRoute
{
    Address = <span class="hljs-keyword">new List&lt;SoaAddress&gt;
    {
        addr
    },
    ServiceDescriptor = <span class="hljs-keyword">new SoaServiceDesc { Id = <span class="hljs-string">"Soa.ServiceDiscovery.InServer.GetRoutesDescAsync" }
};</span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>在主服务（Soa.Sample.Web）中的appsettings.json中，配置如下：</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="13" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%20%20%20%20%5C%22Discovery%5C%22%3A%20%5C%22InServer%5C%22%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">    <span class="hljs-string">"Discovery": <span class="hljs-string">"InServer"
</span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>配置服务发现，当前设置的轮询间隔为每分钟执行一次</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="12" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%20%20%20%20%5C%22InServiceDiscovery%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%5C%22Enable%5C%22%3A%20true%2C%5Cn%20%20%20%20%20%20%5C%22JobCron%5C%22%3A%20%5C%220%20*%20*%20*%20*%20%3F%20%5C%22%5Cn%20%20%20%20%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">    <span class="hljs-string">"InServiceDiscovery": {
      <span class="hljs-string">"Enable": <span class="hljs-literal">true,
      <span class="hljs-string">"JobCron": <span class="hljs-string">"0 * * * * ? "
    }</span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>各个服务Host的appsettings.json中，只需要配置Discovery即可：</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="11" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%20%20%20%20%5C%22Discovery%5C%22%3A%20%5C%22InServer%5C%22%2C%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">    <span class="hljs-string">"Discovery": <span class="hljs-string">"InServer",</span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<h3>Consul</h3>
<p>可以使用UseConsulForDiscovery方法配置基于consul的服务发现功能</p>
<p>consul是google开源的一个使用go语言开发的服务发现、配置管理中心服务。内置了服务注册与发现框 架、分布一致性协议实现、健康检查、Key/Value存储、多数据中心方案</p>
<p>首先去consul官网下载二进制文件</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="10" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" title="Downloads | Consul by HashiCorp" href="https://www.consul.io/downloads" data-cke-enter-mode="2" data-cke-saved-href="https://www.consul.io/downloads" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fwww.consul.io%2Fdownloads%22%2C%22text%22%3A%22Downloads%20%7C%20Consul%20by%20HashiCorp%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22id%22%3A%22xs2q1x-1652174174471%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.0/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M3K6" data-link-title="Downloads | Consul by HashiCorp" data-widget="csdnlink">Downloads | Consul by HashiCorp</a></span></p>
<p>安装直接下载zip包，解压后只有一个可执行的文件consul，将consul添加到系统的环境变量里面。</p>
<p>打开命令行并输入consul.exe &nbsp;agent -dev -bind {你本机的ip地址} 来运行consul服务</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="9" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/36d460eea2c440fd840153b5b72e0c10.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="835" height="433" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/36d460eea2c440fd840153b5b72e0c10.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F36d460eea2c440fd840153b5b72e0c10.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22835%22%2C%22height%22%3A%22433%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​​</span></span></span></p>
<p>在主服务（Soa.Sample.Web）和各个服务Host的appsettings.json中，配置如下：</p>
<p>配置文件中设置Discovery</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="8" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%20%20%20%20%5C%22Discovery%5C%22%3A%20%5C%22Consul%5C%22%2C%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">    <span class="hljs-string">"Discovery": <span class="hljs-string">"Consul",
</span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>设置Consul</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="7" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%20%20%20%20%5C%22ConsulServiceDiscovery%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%5C%22Ip%5C%22%3A%20%5C%22127.0.0.1%5C%22%2C%5Cn%20%20%20%20%20%20%5C%22Port%5C%22%3A%20%5C%228500%5C%22%5Cn%20%20%20%20%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs">    <span class="hljs-string">"ConsulServiceDiscovery": {
      <span class="hljs-string">"Ip": <span class="hljs-string">"127.0.0.1",
      <span class="hljs-string">"Port": <span class="hljs-string">"8500"
    }</span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>&nbsp;&nbsp;注意8500为consul所在ip地址</p>
<p>&nbsp;服务运行时将自动注册ip和服务名称到consul的kv中，待客户端调用时，只需要传入key值即可</p>
<p>当服务运行之后，在浏览器地址栏输入127.0.0.1:8500查看已在consul注册的服务</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="6" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/d84ad4254b1e4aef986fd0b3777b68ec.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" width="1019" height="423" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/d84ad4254b1e4aef986fd0b3777b68ec.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p6X5pmTbHg=,size_20,color_FFFFFF,t_70,g_se,x_16" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fd84ad4254b1e4aef986fd0b3777b68ec.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZHJvaWRzYW5zZmFsbGJhY2s%2Cshadow_50%2Ctext_Q1NETiBA5p6X5pmTbHg%3D%2Csize_20%2Ccolor_FFFFFF%2Ct_70%2Cg_se%2Cx_16%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221019%22%2C%22height%22%3A%22423%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​​</span></span></span></p>
<p>&nbsp;</p>
<h2><strong>服务监控</strong></h2>
<p>在​ServicesManagerController是获取服务列表和服务详情的Api接口控制器</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="5" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22cs%22%2C%22code%22%3A%22%20%20%20%20%5BRoute(%5C%22api%2F%5Bcontroller%5D%2F%5Baction%5D%5C%22)%5D%5Cn%20%20%20%20public%20class%20ServicesManagerController%3AAbpController%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20private%20readonly%20IClientServiceDiscovery%20clientServiceDiscovery%3B%5Cn%5Cn%20%20%20%20%20%20%20%20public%20ServicesManagerController(IClientServiceDiscovery%20clientServiceDiscovery)%5Cn%20%20%20%20%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20this.clientServiceDiscovery%20%3D%20clientServiceDiscovery%3B%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%5BHttpGet%5D%5Cn%20%20%20%20%20%20%20%20public%20async%20Task%3CList%3CSoaAddress%3E%3E%20GetAddresses()%5Cn%20%20%20%20%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20var%20addresses%20%3D%20await%20clientServiceDiscovery.GetAddressAsync()%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20return%20addresses%3B%5Cn%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%5Cn%5Cn%20%20%20%20%20%20%20%20%5BHttpGet%5D%5Cn%20%20%20%20%20%20%20%20public%20async%20Task%3CList%3CSoaServiceDesc%3E%3E%20GetServices(string%20server)%5Cn%20%20%20%20%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20var%20routes%20%3D%20await%20clientServiceDiscovery.GetRoutesAsync()%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20if%20(routes%20!%3D%20null%20%26%26%20routes.Any()%20%26%26%20!string.IsNullOrEmpty(server))%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20(from%20route%20in%20routes%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20where%20route.Address.Any(x%20%3D%3E%20x.Code%20%3D%3D%20server)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20select%20route.ServiceDescriptor).ToList()%3B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20return%20(from%20route%20in%20routes%20select%20route.ServiceDescriptor).ToList()%3B%5Cn%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%7D%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-cs hljs">    [<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]/[action]")]
    <span class="hljs-keyword">public <span class="hljs-keyword">class <span class="hljs-title">ServicesManagerController:<span class="hljs-title">AbpController
    {
        <span class="hljs-keyword">private <span class="hljs-keyword">readonly IClientServiceDiscovery clientServiceDiscovery;

        <span class="hljs-function"><span class="hljs-keyword">public <span class="hljs-title">ServicesManagerController(<span class="hljs-params">IClientServiceDiscovery clientServiceDiscovery)
        {
            <span class="hljs-keyword">this.clientServiceDiscovery = clientServiceDiscovery;
        }
      
        [<span class="hljs-meta">HttpGet]
        <span class="hljs-keyword">public <span class="hljs-keyword">async Task&lt;List&lt;SoaAddress&gt;&gt; GetAddresses()
        {
            <span class="hljs-keyword">var addresses = <span class="hljs-keyword">await clientServiceDiscovery.GetAddressAsync();
            <span class="hljs-keyword">return addresses;

        }


        [<span class="hljs-meta">HttpGet]
        <span class="hljs-keyword">public <span class="hljs-keyword">async Task&lt;List&lt;SoaServiceDesc&gt;&gt; GetServices(<span class="hljs-built_in">string server)
        {
            <span class="hljs-keyword">var routes = <span class="hljs-keyword">await clientServiceDiscovery.GetRoutesAsync();
            <span class="hljs-keyword">if (routes != <span class="hljs-literal">null &amp;&amp; routes.Any() &amp;&amp; !<span class="hljs-built_in">string.IsNullOrEmpty(server))
            {
                <span class="hljs-keyword">return (<span class="hljs-keyword">from route <span class="hljs-keyword">in routes
                        <span class="hljs-keyword">where route.Address.Any(x =&gt; x.Code == server)
                        <span class="hljs-keyword">select route.ServiceDescriptor).ToList();
            }
            <span class="hljs-keyword">return (<span class="hljs-keyword">from route <span class="hljs-keyword">in routes <span class="hljs-keyword">select route.ServiceDescriptor).ToList();

        }

    }
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>&nbsp;运行项目，在swagger中调试请求GetSoaService接口，可以获取所有服务信息</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="4" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/3e305b71b2474bf6890c15569e0f27d8.png" alt="" width="917" height="514" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/3e305b71b2474bf6890c15569e0f27d8.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F3e305b71b2474bf6890c15569e0f27d8.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22917%22%2C%22height%22%3A%22514%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​​</span></span></span></p>
<h2>健康监测</h2>
<p>健康监测用于确定各服务的健康程度，比如是否运行缓慢，是否链接顺畅等。</p>
<p>用一个简单的监测链接是否超时方式，确定这个服务是否健康。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="3" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22cs%22%2C%22code%22%3A%22using%20(var%20socket%20%3D%20new%20Socket(AddressFamily.InterNetwork%2C%20SocketType.Stream%2C%20ProtocolType.Tcp)%20%7B%20SendTimeout%20%3D%20timeout%20%7D)%5Cn%7B%5Cn%20%20%20%20try%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20await%20socket.ConnectAsync(server.CreateEndPoint())%3B%5Cn%20%20%20%20%20%20%20%20server.IsHealth%20%3D%20true%3B%5Cn%20%20%20%20%7D%5Cn%20%20%20%20catch%5Cn%20%20%20%20%7B%5Cn%20%20%20%20%20%20%20%20server.IsHealth%20%3D%20false%3B%5Cn%20%20%20%20%7D%5Cn%7D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-cs hljs"><span class="hljs-keyword">using (<span class="hljs-keyword">var socket = <span class="hljs-keyword">new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp) { SendTimeout = timeout })
{
    <span class="hljs-keyword">try
    {
        <span class="hljs-keyword">await socket.ConnectAsync(server.CreateEndPoint());
        server.IsHealth = <span class="hljs-literal">true;
    }
    <span class="hljs-keyword">catch
    {
        server.IsHealth = <span class="hljs-literal">false;
    }
}</span></span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>在主服务（Soa.Sample.Web）和各个服务Host的appsettings.json中，配置如下：</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="2" data-cke-widget-wrapper="1">
<pre class="cke_widget_element" data-cke-widget-data="%7B%22lang%22%3A%22javascript%22%2C%22code%22%3A%22%5C%22HealthCheck%5C%22%3A%20%7B%5Cn%20%20%20%20%20%20%5C%22Enable%5C%22%3A%20true%2C%5Cn%20%20%20%20%20%20%5C%22JobCron%5C%22%3A%20%5C%220%2F5%20*%20*%20*%20*%20%3F%20%5C%22%2C%5Cn%20%20%20%20%20%20%5C%22Timeout%5C%22%3A%203000%5Cn%20%20%20%20%7D%2C%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code class="language-javascript hljs"><span class="hljs-string">"HealthCheck": {
      <span class="hljs-string">"Enable": <span class="hljs-literal">true,
      <span class="hljs-string">"JobCron": <span class="hljs-string">"0/5 * * * * ? ",
      <span class="hljs-string">"Timeout": <span class="hljs-number">3000
    },</span></span></span></span></span></span></span></code></pre>
<span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /></span></div>
<p>&nbsp;这里健康监测服务的轮询时间是5s，超时时间为3000ms</p>
<p>运行后关闭一个微服务，若关闭Service2，请求<a>/api/ServicesManager/GetAddresses</a></p>
<p>可以看到IsHealth变为False</p>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="1" data-cke-widget-wrapper="1"><img src="https://img-blog.csdnimg.cn/a6d246ed6b4b48a9950f16b1bcfee033.png" alt="" width="288" height="117" class="cke_widget_element" data-cke-saved-src="https://img-blog.csdnimg.cn/a6d246ed6b4b48a9950f16b1bcfee033.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fa6d246ed6b4b48a9950f16b1bcfee033.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22288%22%2C%22height%22%3A%22117%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" /><span class="cke_reset cke_widget_drag_handler_container"><img src="https://img2022.cnblogs.com/blog/644861/202205/644861-20220510171735372-1139513227.gif" width="15" height="15" class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" data-cke-widget-drag-handler="1" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></span></p>
<h3>项目地址：</h3>
<p><span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="0" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" title="MatoApps/Soa (github.com)" href="https://github.com/MatoApps/Soa" data-cke-enter-mode="2" data-cke-saved-href="https://github.com/MatoApps/Soa" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fgithub.com%2FMatoApps%2FSoa%22%2C%22text%22%3A%22MatoApps%2FSoa%20(github.com)%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.0%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM3K6%22%2C%22id%22%3A%22RobNHI-1652174174447%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.0/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M3K6" data-link-title="MatoApps/Soa (github.com)" data-widget="csdnlink">MatoApps/Soa (github.com)</a></span></p>
<span data-cke-copybin-start="1"><span data-cke-copybin-end="1">​</span></span>