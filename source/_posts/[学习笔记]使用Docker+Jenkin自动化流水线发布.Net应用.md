---
thumbnail: images/7af1b2a3309048d6bd5ad3dd50dd0102.png
title: '[学习笔记]使用Docker+Jenkin自动化流水线发布.Net应用'
excerpt: >-
  使用Docker容器方案可以快速安全地将项目部署到客户的服务器上，作为公司项目，需要解决两个问题：1.
  需要搭建一个私有的Docker仓库，以便安全的存储镜像2.
  需要一套自动化发布方案，实现代码到应用部署的自动化流程大致流程如下在java世界中有很多文章介绍了Docker+Jenkin的自动化部署方式，这次来看看如何用这一套工具实现.Net
  应用的发布。以Soa项目为例MatoApps/Soa: 一个轻量级的微服务库，基于.Net 6 + Abp框架
  可快速地将现有项目改造成为面向服务体系结构，实现模块间
tags:
  - [.NET]
  - docker
  - jenkins
  - devops
categories:
  - DevOps
  - [Linux]
toc: true
recommend: 1
keywords: categories-java
uniqueId: '2022-06-08 18:38:00/[学习笔记]使用Docker+Jenkin自动化流水线发布.Net应用.html'
abbrlink: 8deee35b
date: 2022-06-08 18:38:00
cover:
description:
---
<p><span data-cke-copybin-start="1"><span data-cke-copybin-start="1">​</span></span><span id="cke_bm_545S">使用Docker容器方案可以快速安全地将项目部署到客户的服务器上，作为公司项目，需要解决两个问题：</span></p><p>1. 需要搭建一个私有的Docker仓库，以便安全的存储镜像</p><p>2. 需要一套自动化发布方案，实现代码到应用部署的自动化流程</p><p>大致流程如下</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="25" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527577-912093450.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F7af1b2a3309048d6bd5ad3dd50dd0102.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22871%22%2C%22height%22%3A%22454%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="454" src="644861-20230420161527577-912093450.png" width="871"/></span></p><p>在java世界中有很多文章介绍了Docker+Jenkin的自动化部署方式，这次来看看如何用这一套工具实现.Net 应用的发布。</p><h2>编写DockerFile</h2><p>以Soa项目为例<span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="24" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" data-cke-enter-mode="2" data-cke-saved-href="https://github.com/MatoApps/Soa" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fgithub.com%2FMatoApps%2FSoa%22%2C%22text%22%3A%22MatoApps%2FSoa%3A%20%E4%B8%80%E4%B8%AA%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%93%EF%BC%8C%E5%9F%BA%E4%BA%8E.Net%206%20%2B%20Abp%E6%A1%86%E6%9E%B6%20%E5%8F%AF%E5%BF%AB%E9%80%9F%E5%9C%B0%E5%B0%86%E7%8E%B0%E6%9C%89%E9%A1%B9%E7%9B%AE%E6%94%B9%E9%80%A0%E6%88%90%E4%B8%BA%E9%9D%A2%E5%90%91%E6%9C%8D%E5%8A%A1%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%EF%BC%8C%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9D%97%E9%97%B4%E6%9D%BE%E8%80%A6%E5%90%88%E3%80%82%20(github.com)%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.3%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM4AD%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.3%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM4AD%22%2C%22id%22%3A%22qZI5yu-1654684429889%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.3/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M4AD" data-link-title="MatoApps/Soa: 一个轻量级的微服务库，基于.Net 6 + Abp框架 可快速地将现有项目改造成为面向服务体系结构，实现模块间松耦合。 (github.com)" data-widget="csdnlink" href="https://github.com/MatoApps/Soa" title="MatoApps/Soa: 一个轻量级的微服务库，基于.Net 6 + Abp框架 可快速地将现有项目改造成为面向服务体系结构，实现模块间松耦合。 (github.com)">MatoApps/Soa: 一个轻量级的微服务库，基于.Net 6 + Abp框架 可快速地将现有项目改造成为面向服务体系结构，实现模块间松耦合。 (github.com)</a></span></p><p>Soa/sample/MainHost/Soa.GatewaySample.Web.Host/Dockerfile</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="23" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22code%22%3A%22FROM%20mcr.microsoft.com%2Fdotnet%2Faspnet%3A6.0%20AS%20base%5CnWORKDIR%20%2Fapp%5CnEXPOSE%2080%5CnEXPOSE%20443%5CnEXPOSE%2044311%5Cn%5CnFROM%20mcr.microsoft.com%2Fdotnet%2Fsdk%3A6.0%20AS%20build%5CnWORKDIR%20%2Fsrc%5CnCOPY%20%5B%5C%22sample%2FMainHost%2FSoa.GatewaySample.Web.Host%2FSoa.GatewaySample.Web.Host.csproj%5C%22%2C%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.Web.Host%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FMainHost%2FSoa.GatewaySample.Web.Core%2FSoa.GatewaySample.Web.Core.csproj%5C%22%2C%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.Web.Core%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FMainHost%2FSoa.GatewaySample.Application%2FSoa.GatewaySample.Application.csproj%5C%22%2C%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.Application%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FMainHost%2FSoa.GatewaySample.Core%2FSoa.GatewaySample.Core.csproj%5C%22%2C%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.Core%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FServices.Abstract%2FSoa.Sample.IService2%2FSoa.Sample.IService2.csproj%5C%22%2C%20%5C%22sample%2FServices.Abstract%2FSoa.Sample.IService2%2F%5C%22%5D%5CnCOPY%20%5B%5C%22src%2FSoa%2FSoa.csproj%5C%22%2C%20%5C%22src%2FSoa%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FServices.Abstract%2FSoa.Sample.IAuthorizedService%2FSoa.Sample.IAuthorizedService.csproj%5C%22%2C%20%5C%22sample%2FServices.Abstract%2FSoa.Sample.IAuthorizedService%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FServices.Abstract%2FSoa.Sample.IService1%2FSoa.Sample.IService1.csproj%5C%22%2C%20%5C%22sample%2FServices.Abstract%2FSoa.Sample.IService1%2F%5C%22%5D%5CnCOPY%20%5B%5C%22sample%2FMainHost%2FSoa.GatewaySample.EntityFrameworkCore%2FSoa.GatewaySample.EntityFrameworkCore.csproj%5C%22%2C%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.EntityFrameworkCore%2F%5C%22%5D%5CnCOPY%20%5B%5C%22src%2FSoa.Client%2FSoa.Client.csproj%5C%22%2C%20%5C%22src%2FSoa.Client%2F%5C%22%5D%5CnRUN%20dotnet%20restore%20%5C%22sample%2FMainHost%2FSoa.GatewaySample.Web.Host%2FSoa.GatewaySample.Web.Host.csproj%5C%22%5CnCOPY%20.%20.%5CnWORKDIR%20%5C%22%2Fsrc%2Fsample%2FMainHost%2FSoa.GatewaySample.Web.Host%5C%22%5CnRUN%20dotnet%20build%20%5C%22Soa.GatewaySample.Web.Host.csproj%5C%22%20-c%20Release%20-o%20%2Fapp%2Fbuild%5Cn%5CnFROM%20build%20AS%20publish%5CnRUN%20dotnet%20publish%20%5C%22Soa.GatewaySample.Web.Host.csproj%5C%22%20-c%20Release%20-o%20%2Fapp%2Fpublish%5Cn%5CnFROM%20base%20AS%20final%5CnWORKDIR%20%2Fapp%5CnCOPY%20--from%3Dpublish%20%2Fapp%2Fpublish%20.%5CnENTRYPOINT%20%5B%5C%22dotnet%5C%22%2C%20%5C%22Soa.GatewaySample.Web.Host.dll%5C%22%5D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>FROM mcr.microsoft.com/dotnet/aspnet:6.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443
EXPOSE 44311

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /src
COPY ["sample/MainHost/Soa.GatewaySample.Web.Host/Soa.GatewaySample.Web.Host.csproj", "sample/MainHost/Soa.GatewaySample.Web.Host/"]
COPY ["sample/MainHost/Soa.GatewaySample.Web.Core/Soa.GatewaySample.Web.Core.csproj", "sample/MainHost/Soa.GatewaySample.Web.Core/"]
COPY ["sample/MainHost/Soa.GatewaySample.Application/Soa.GatewaySample.Application.csproj", "sample/MainHost/Soa.GatewaySample.Application/"]
COPY ["sample/MainHost/Soa.GatewaySample.Core/Soa.GatewaySample.Core.csproj", "sample/MainHost/Soa.GatewaySample.Core/"]
COPY ["sample/Services.Abstract/Soa.Sample.IService2/Soa.Sample.IService2.csproj", "sample/Services.Abstract/Soa.Sample.IService2/"]
COPY ["src/Soa/Soa.csproj", "src/Soa/"]
COPY ["sample/Services.Abstract/Soa.Sample.IAuthorizedService/Soa.Sample.IAuthorizedService.csproj", "sample/Services.Abstract/Soa.Sample.IAuthorizedService/"]
COPY ["sample/Services.Abstract/Soa.Sample.IService1/Soa.Sample.IService1.csproj", "sample/Services.Abstract/Soa.Sample.IService1/"]
COPY ["sample/MainHost/Soa.GatewaySample.EntityFrameworkCore/Soa.GatewaySample.EntityFrameworkCore.csproj", "sample/MainHost/Soa.GatewaySample.EntityFrameworkCore/"]
COPY ["src/Soa.Client/Soa.Client.csproj", "src/Soa.Client/"]
RUN dotnet restore "sample/MainHost/Soa.GatewaySample.Web.Host/Soa.GatewaySample.Web.Host.csproj"
COPY . .
WORKDIR "/src/sample/MainHost/Soa.GatewaySample.Web.Host"
RUN dotnet build "Soa.GatewaySample.Web.Host.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "Soa.GatewaySample.Web.Host.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Soa.GatewaySample.Web.Host.dll"]</code></pre>
</div><p> </p><h2>搭建CI/CD服务器</h2><p>CI/CD服务器用于将代码端到仓库的自动化发布，假设你已经拥有一台CentOS 7的服务器，IP地址为192.168.31.69，并且已经安装好了Docker和Jenkins。</p><p>安装私有仓库</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="22" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20docker%20pull%20registry%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo docker pull registry</code></pre>
</div><p>设置启动方式为后台任务，端口为5000，并设置随docker服务一同启动</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="21" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20docker%20run%20-d%20-p%205000%3A5000%20--restart%20always%20%20registry%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo docker run -d -p 5000:5000 --restart always  registry</code></pre>
</div><p>更改docker.service</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="20" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20nano%20%2Fusr%2Flib%2Fsystemd%2Fsystem%2Fdocker.service%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo nano /usr/lib/systemd/system/docker.service</code></pre>
</div><p>在ExecStart命令后面添加参数，添加本机IP地址到registry中 </p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="19" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22code%22%3A%22%5BService%5D%5CnExecStart%3D%2Fusr%2Fbin%2Fdockerd%20--insecure-registry%20192.168.31.69%3A5000%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>[Service]
ExecStart=/usr/bin/dockerd --insecure-registry 192.168.31.69:5000</code></pre>
</div><p>重启docker服务 </p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="18" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20systemctl%20daemon-reload%5Cnsudo%20systemctl%20restart%20docker%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo systemctl daemon-reload
sudo systemctl restart docker</code></pre>
</div><p>[可选]安装并运行whalerator，whalerator是一个docker镜像仓库可视化工具，可以提供类似Docker Hub的方式浏览镜像</p><p> <span class="cke_widget_wrapper cke_widget_inline cke_widget_csdnlink cke_widget_selected" data-cke-display-name="a" data-cke-filter="off" data-cke-widget-id="17" data-cke-widget-wrapper="1"><a class="cke_widget_editable cke_widget_element" data-cke-enter-mode="2" data-cke-saved-href="https://github.com/jevonsflash/whalerator" data-cke-widget-data="%7B%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fjevonsflash%2Fwhalerator%22%2C%22text%22%3A%22jevonsflash%2Fwhalerator%3A%20Portable%20front%20end%20for%20Docker%20Registry%20(github.com)%22%2C%22desc%22%3A%22%22%2C%22icon%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.3%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM4AD%22%2C%22isCard%22%3Afalse%2C%22hasResquest%22%3Atrue%2C%22iconDefault%22%3A%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblog_editor_html%2Frelease2.1.3%2Fckeditor%2Fplugins%2FCsdnLink%2Ficons%2Ficon-default.png%3Ft%3DM4AD%22%2C%22id%22%3A%22Hxby0i-1654684429884%22%2C%22classes%22%3Anull%7D" data-cke-widget-editable="text" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-link-icon="https://csdnimg.cn/release/blog_editor_html/release2.1.3/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=M4AD" data-link-title="jevonsflash/whalerator: Portable front end for Docker Registry (github.com)" data-widget="csdnlink" href="https://github.com/jevonsflash/whalerator" title="jevonsflash/whalerator: Portable front end for Docker Registry (github.com)">jevonsflash/whalerator: Portable front end for Docker Registry (github.com)</a></span></p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="16" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20docker%20run%20-d%20-p%208081%3A80%20--restart%20always%20whalerator%2Fwhalerator%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo docker run -d -p 8081:80 --restart always whalerator/whalerator</code></pre>
</div><p> 测试</p><p>下载从dockerhub上下载一个仓库，再将他提交到私有仓库中</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="15" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20docker%20pull%20jevonsflash%2Fsoasampleauthorizedservicehost%3Alatest%5Cnsudo%20docker%20tag%20jevonsflash%2Fsoasampleauthorizedservicehost%3Alatest%20192.168.31.69%3A5000%2Fsoasampleauthorizedservicehost%3Alatest%5Cnsudo%20docker%20push%20192.168.31.69%3A5000%2Fsoasampleauthorizedservicehost%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo docker pull jevonsflash/soasampleauthorizedservicehost:latest
sudo docker tag jevonsflash/soasampleauthorizedservicehost:latest 192.168.31.69:5000/soasampleauthorizedservicehost:latest
sudo docker push 192.168.31.69:5000/soasampleauthorizedservicehost</code></pre>
</div><p>防火墙开启8081与8082端口以便外部环境可以访问</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="14" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22firewall-cmd%20--zone%3Dpublic%20--add-port%3D8081%2Ftcp%20--permanent%5Cnfirewall-cmd%20--zone%3Dpublic%20--add-port%3D8080%2Ftcp%20--permanent%5Cnfirewall-cmd%20--reload%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>firewall-cmd --zone=public --add-port=8081/tcp --permanent
firewall-cmd --zone=public --add-port=8080/tcp --permanent
firewall-cmd --reload</code></pre>
</div><p>在同网段下的浏览器中输入 http://192.168.31.69:8081, 将跳转至管理页面</p><p>选择Anonymous匿名登陆，输入192.168.31.69:5000，点击Submit</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="13" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527606-479551412.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F00dccea5cb394d449d66d8c7aa6e3183.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221009%22%2C%22height%22%3A%22556%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="556" src="644861-20230420161527606-479551412.png" width="1009"/></span></p><p> 可以看到soasampleauthorizedservicehost:latest已经存在于仓库内了</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="12" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527684-1084204658.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F8db07ac0ed0e4912b4346e4b81569d96.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221011%22%2C%22height%22%3A%22531%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="531" src="644861-20230420161527684-1084204658.png" width="1011"/></span></p><h2>配置Jenkins </h2><p>首先配置Jenkins的shell脚本权限</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="11" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22code%22%3A%22sudo%20visudo%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo visudo</code></pre>
</div><p> 在文件末尾添加规则，这样执行sudo命令时将跳过root管理员密码验证</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="10" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22code%22%3A%22jenkins%20%20%20%20%20%20%20%20%20ALL%3D(ALL)%20NOPASSWD%3AALL%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>jenkins         ALL=(ALL) NOPASSWD:ALL</code></pre>
</div><p>重启jenkins </p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="9" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20systemctl%20restart%20jenkins%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo systemctl restart jenkins</code></pre>
</div><p>在同网段下的浏览器打开http://192.168.31.69:8080， 打开Jenkins管理界面</p><p>Dashboard - 新建任务，选择“构建一个自由风格的软件项目” </p><p>这里暂且命名为test</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="8" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527635-1403978437.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F4b711613258447e683287802ca55373c.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221200%22%2C%22height%22%3A%22622%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="622" src="644861-20230420161527635-1403978437.png" width="1200"/></span></p><p> 在源码管理中填写Git仓库地址，并且填写正确的鉴权信息</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="7" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527641-828986307.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fe0eda405c31943a3ad45d8b685e22efe.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22711%22%2C%22height%22%3A%22736%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="736" src="644861-20230420161527641-828986307.png" width="711"/></span></p><p> 在构建中添加一个“执行 shell” 步骤</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="6" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527675-622006661.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F2b4d50c0faa241358baf827384609425.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22323%22%2C%22height%22%3A%22270%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="270" src="644861-20230420161527675-622006661.png" width="323"/></span></p><p> 在命令中输入以下内容</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="5" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22lang%22%3A%22bash%22%2C%22code%22%3A%22sudo%20docker%20build%20-f%20.%2Fsample%2FMainHost%2FSoa.GatewaySample.Web.Host%2FDockerfile%20-t%20192.168.31.69%3A5000%2Fsoasampleauthorizedservicehost%20--no-cache%20--target%20final%20.%2F%5Cnsudo%20docker%20push%20192.168.31.69%3A5000%2Fsoasampleauthorizedservicehost%5Cn%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>sudo docker build -f ./sample/MainHost/Soa.GatewaySample.Web.Host/Dockerfile -t 192.168.31.69:5000/soasampleauthorizedservicehost --no-cache --target final ./
sudo docker push 192.168.31.69:5000/soasampleauthorizedservicehost</code></pre>
</div><p>这些命令将在构建时，在源代码拉取后执行</p><ol>
<li>将指定 ./sample/MainHost/Soa.GatewaySample.Web.Host/Dockerfile构建镜像，并命名为192.168.31.69:5000/soasampleauthorizedservicehost</li>
<li>将192.168.31.69:5000/soasampleauthorizedservicehost镜像推送至私有docker仓库</li>
</ol><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="4" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527642-930619807.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F19500187a99d40de85c75b830683158b.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22678%22%2C%22height%22%3A%22340%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="340" src="644861-20230420161527642-930619807.png" width="678"/></span></p><p>  至此搭建CI/CD服务器工作结束。</p><h2>测试和发布</h2><p>返回Dashboard，在test项目下选择“立即构建”</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="3" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527583-784275692.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Fc94fa9f052c149d2b3651831a8d28a15.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%22481%22%2C%22height%22%3A%22365%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="365" src="644861-20230420161527583-784275692.png" width="481"/></span></p><p>等待构建成功</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="2" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527627-441818161.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F15ec34ddd473498da5a1c39f78b6b477.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221200%22%2C%22height%22%3A%22745%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="745" src="644861-20230420161527627-441818161.png" width="1200"/></span></p><p> 再次打开 http://192.168.31.69:8081, 打开Docker仓库管理页面，可以发现发布时间已更新</p><p><span class="cke_widget_wrapper cke_widget_inline cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-display-name="图像" data-cke-filter="off" data-cke-widget-id="1" data-cke-widget-wrapper="1"><img alt="" class="cke_widget_element" data-cke-saved-src="https://img2023.cnblogs.com/blog/644861/202304/644861-20230420161527690-748254860.png" data-cke-widget-data="%7B%22hasCaption%22%3Afalse%2C%22src%22%3A%22https%3A%2F%2Fimg-blog.csdnimg.cn%2Ff9876a1b9de7416996ec6a6c456dd466.png%22%2C%22alt%22%3A%22%22%2C%22width%22%3A%221007%22%2C%22height%22%3A%22690%22%2C%22lock%22%3Atrue%2C%22align%22%3A%22none%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="image" height="690" src="644861-20230420161527690-748254860.png" width="1007"/></span></p><p> 至此部署工作结束。</p><p>在客户机上需要安装Docker并且配置好IP地址，当然CI/CD服务器需要映射到一个公网IP地址上，以便客户的服务器拉取镜像</p><div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_selected" data-cke-display-name="代码段" data-cke-filter="off" data-cke-widget-id="0" data-cke-widget-wrapper="1">
<pre class="cke_widget_element highlighter-hljs" data-cke-widget-data="%7B%22code%22%3A%22%5BService%5D%5CnExecStart%3D%2Fusr%2Fbin%2Fdockerd%20--insecure-registry%20%5BCI%2FCD%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%B0%E5%9D%80%5D%22%2C%22classes%22%3Anull%7D" data-cke-widget-keep-attr="0" data-cke-widget-upcasted="1" data-widget="codeSnippet"><code>[Service]
ExecStart=/usr/bin/dockerd --insecure-registry [CI/CD服务器地址]</code></pre>
</div><p> </p><p> </p><p> </p><p><span data-cke-copybin-start="1"> <span data-cke-copybin-end="1">​</span></span></p>